<!--
@license
Copyright (c) 2016 Vicomtech-IK4. All rights reserved.
This code may only be used under the Apache License 2.0 found at http://volumerc.github.io/tf-editor/LICENSE.txt
The complete set of attributions may be found at http://volumerc.github.io/tf-editor/NOTICE
-->
<html><head><meta charset="UTF-8">
<!--
`<tf-editor>`
A Web based transfer function editor for volume rendering.

Typical use, just insert `<tf-editor>` along a volume rendering scene into your
page. Optionally, pass the volume data as a flatten array to show an histogram
and fit the control points to the data.

    <body>
      <tf-editor id="TF"></tf-editor>
    </body>

The output canvas selector string will be reflected in the `output` attribute,
if no input selector is provided.
Check out the demo page for examples of the different use cases in action.

@demo ./demo/index.html  Showcase of the different attribute arguments!
-->
</head><body>
  <div hidden="" by-vulcanize="">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.8.0/d3.min.js"></script>
  </div>
  <dom-module id="tf-editor">
    <template>
    <style>
      :host{display:block}.bar rect{fill:steelblue}.aligned{margin:0 auto;display:inline-flex}button{border:1px solid;padding:1px 2px;margin-right:2px;margin-left:2px;height:23px;cursor:pointer;overflow:visible}button::-moz-focus-inner{border:0;padding:1px 2px}input[type=color]{border:1px solid;width:44px;height:23px;margin-left:2px;margin-right:2px;padding:1px 2px;cursor:pointer}rect{fill:none;pointer-events:all}.line{stroke:black;stroke-width:1.5px}circle{fill-opacity:.6;cursor:move;stroke:black;stroke-width:1.5px}.selected{fill:#ff7f0e;stroke:#ff7f0e}
    </style>
    <div id="container">
      <svg id="svg-{{id}}" width$="{{width}}" height$="{{height}}"></svg>
      <div class="aligned">
        <input type="color" id="picker-{{id}}">
        <button id="export-{{id}}">Export</button>
        <template is="dom-if" if="{{_external}}">
          <canvas id="canvas-{{id}}" width="255" height="10"></canvas>
        </template>
    </div>
    </div>
    </template>
    <script>
    var $jscomp={scope:{},findInternal:function(a,b,c){a instanceof String&&(a=String(a));for(var e=a.length,d=0;d<e;d++){var g=a[d];if(b.call(c,g,d,a))return{i:d,v:g}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
    $jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,e){if(b){c=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var d=a[e];d in c||(c[d]={});c=c[d]}a=a[a.length-1];e=c[a];b=b(e);b!=e&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
    $jscomp.polyfill("Array.prototype.findIndex",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).i}},"es6-impl","es3");
    Polymer({is:"tf-editor",_createElements:function(){this.margin={top:10,right:20,bottom:20,left:25};this.formatCount=d3.format(",.0f");this.xScale=d3.scaleLinear();this.yScale=d3.scaleLinear();this.binScale=d3.scaleLog();this.area=d3.area();this.bins=d3.histogram();this.canvasScale=d3.scaleLinear();this.dataScale=d3.scaleLinear();this.selected=this.dragged=null;this.last_color="green"},_initializeElements:function(){var a=[0,255];this.fitToData&&this._data&&0<this._data.length&&(a=d3.extent(this._data));
    var b=this;this.xScale.rangeRound([0,this._width]).domain(a);this.yScale.domain([0,1]).range([this._height,0]);this.binScale.domain([1,10]).range([this._height,0]).base(2).clamp([0,this._height]);this.bins.domain(this.xScale.domain()).thresholds(this.xScale.ticks(this.numberBins));0==this.controlPoints.length&&(this.push("controlPoints",{x:a[0],opacity:0,color:"blue"}),this.push("controlPoints",{x:a[1],opacity:1,color:"red"}));this.selected=this.controlPoints[0];this.area.x(function(a){return b.xScale(a.x)}).y0(function(a){return b.yScale(a.opacity)}).y1(this._height).curve(d3.curveLinear);
    this.canvasScale.range([0,1]);this.dataScale.domain(a).range([0,255]);this.canvasSelector=this.canvasSelector||"#canvas-"+this.id;this.$$("#picker-"+this.id).addEventListener("change",function(){b.last_color=this.value});this.$$("#export-"+this.id).addEventListener("click",function(){b._export.call(b)})},_canvasContext:function(){var a=this._external?this.$$(this.canvasSelector):document.querySelector(this.canvasSelector);return null!=a?a.getContext("2d"):a},_drawChart:function(){var a=this,b=this.svg.append("g").attr("transform",
    "translate("+this.margin.left+","+this.margin.top+")");this._redrawHistogram();b.append("defs").append("linearGradient").attr("id","tfGradient-"+this.id).attr("gradientUnits","objectBoundingBox").attr("spreadMethod","pad").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%");b.append("path").datum(a.controlPoints).attr("class","line").attr("fill","url(#tfGradient-"+this.id+")").attr("stroke","black").call(function(){a._redraw()});b.append("rect").attr("y",-10).attr("x",-10).attr("width",
    a._width+20).attr("height",a._height+20).style("opacity",0).on("mousedown",function(){a._mousedown()}).on("mouseup",function(){a._mouseup()}).on("mousemove",function(){a._mousemove()});var c=a.xScale.ticks(a.numberTicks);c[c.length-1]=a.xScale.domain()[1];b.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+a._height+")").call(d3.axisBottom(a.xScale).tickValues(c));b.append("g").attr("class","axis axis--y").attr("transform","translate(0, 0)").call(d3.axisLeft(a.yScale).ticks(a.numberTicks))},
    _updateScales:function(){if(this.fitToData){for(var a=d3.extent(this._data),b=-1,c=-1,e=this.controlPoints,d=e.length-1;0<=d;d--)if(c=e[d].x>=a[1]?d:c,e[d].x<=a[0]){b=d;break}-1!=c&&(e[c].x=a[1],e.splice(c,e.length-c-1));-1!=b&&(e[b].x=a[0],e.splice(0,b));this.controlPoints=[];this.controlPoints=e;this.xScale.domain(a);this.dataScale.domain(a)}else this.xScale.domain([0,255]),this.dataScale.domain([0,255]);this.bins.domain(this.xScale.domain()).thresholds(this.xScale.ticks(this.numberBins))},_updateAxis:function(){var a=
    d3.select(this.$$("svg")).select("g"),b=this.xScale.ticks(this.numberTicks);b[b.length-1]=this.xScale.domain()[1];a.selectAll(".axis.axis--x").call(d3.axisBottom(this.xScale).tickValues(b))},_redrawHistogram:function(){var a=this;this.svg.select("g").selectAll(".bar").remove();if(this._data&&0<this._data.length){var b=this.bins(this._data);this.binScale.domain([.1,d3.max(b,function(a){return a.length})]);b=this.svg.select("g").selectAll(".bar").data(b);b.enter().append("g").attr("class","bar").attr("transform",
    function(b){return"translate("+a.xScale(b.x0)+","+a.binScale(b.length)+")"}).append("rect").attr("x",1).attr("width",function(a){return a.x1-a.x0}).attr("height",function(b){return a._height-a.binScale(b.length)});this.svg.select("g").selectAll(".bar").lower();b.exit().remove()}},_redraw:function(){var a=this,b=d3.select(a.$$("svg")).select("g");b.select("path").datum(a.controlPoints).attr("d",a.area);var c=b.selectAll("circle").data(a.controlPoints);c.enter().append("circle").attr("cx",function(b){return a.xScale(b.x)}).attr("cy",
    function(b){return a.yScale(b.opacity)}).style("fill",function(a){return a.color}).attr("r",1E-6).on("mousedown",function(b){a.selected=a.dragged=b;a.last_color=b.color;a._redraw()}).on("mouseup",function(){a._mouseup()}).on("contextmenu",function(b,c){d3.event.preventDefault();b.color=a.$$("#picker-"+a.id).value;a._redraw()}).transition().duration(750).attr("r",5);c.classed("selected",function(b){return b===a.selected}).style("fill",function(a){return a.color}).attr("cx",function(b){return a.xScale(b.x)}).attr("cy",
    function(b){return a.yScale(b.opacity)}).raise();c.exit().remove();b=b.select("linearGradient").selectAll("stop").data(a.controlPoints);b.enter().append("stop").attr("stop-color",function(a){return a.color}).attr("stop-opacity",function(a){return a.opacity}).attr("offset",function(b){return""+(b.x-a.controlPoints[0].x)/(a.controlPoints[a.controlPoints.length-1].x-a.controlPoints[0].x)*100+"%"});b.attr("stop-color",function(a){return a.color}).attr("stop-opacity",function(a){return a.opacity}).attr("offset",
    function(b){return""+(b.x-a.controlPoints[0].x)/(a.controlPoints[a.controlPoints.length-1].x-a.controlPoints[0].x)*100+"%"});b.exit().remove();d3.event&&(d3.event.preventDefault(),d3.event.stopPropagation());b=this.controlPoints;this.controlPoints=[];this.controlPoints=b;d3.timeout(function(){a._drawCanvas()},100)},_drawCanvas:function(){if(void 0!=this.controlPoints&&0<this.controlPoints.length){var a=[this.controlPoints[0].x,this.controlPoints[this.controlPoints.length-1].x],b=this.dataScale(a[0]),
    a=this.dataScale(a[1]);this.canvasScale.domain([b,a]);var c=this._canvasContext();if(null!=c){c.clearRect(0,0,255,10);for(var e=c.createLinearGradient(b,0,a,0),d=0;d<this.controlPoints.length;d++){var g=this.controlPoints[d],f=d3.color(g.color);f.opacity=g.opacity;e.addColorStop(this.canvasScale(this.dataScale(g.x)),f.toString())}c.fillStyle=e;c.fillRect(b,0,a-b,10);void 0!=c.canvas.parentNode._x3domNode&&c.canvas.parentNode._x3domNode.invalidateGLObject();this.fire("updated-tf","")}}},_mousedown:function(){var a=
    d3.mouse(this.svg.node());this.selected=this.dragged=point={x:this.xScale.invert(Math.max(0,Math.min(a[0]-this.margin.left,this._width))),opacity:this.yScale.invert(Math.max(0,Math.min(a[1]-this.margin.top,this._height))),color:this.last_color};a=d3.bisector(function(a,c){return a.x-c.x}).left;a=a(this.controlPoints,point);this.splice("controlPoints",a,0,point);this._redraw()},_mousemove:function(){if(this.dragged){var a=this.controlPoints.findIndex(function(a,b,c){return a.x==this.x&&a.opacity==
    this.opacity&&a.color==this.color},this.selected);if(-1!=a){var b=d3.mouse(this.svg.node());this.selected=this.dragged=this.controlPoints[a];this.dragged.x=this.xScale.invert(Math.max(0,Math.min(this._width,b[0]-this.margin.left)));this.dragged.opacity=this.yScale.invert(Math.max(0,Math.min(this._height,b[1]-this.margin.top)));var c=d3.bisector(function(a,b){return a.x-b.x}).left,b=d3.bisector(function(a,b){return a.x-b.x}).right,c=c(this.controlPoints,this.dragged),b=b(this.controlPoints,this.dragged);
    c<a?this.splice("controlPoints",c,1):c>a?this.splice("controlPoints",a+1,1):2<=b-a&&this.splice("controlPoints",a+1,1);this._redraw()}}},_mouseup:function(){this.dragged&&(this.dragged=null)},_keydown:function(){if(this.selected)switch(d3.event.keyCode){case 46:var a=this.controlPoints.indexOf(this.selected);this.splice("controlPoints",a,1);this.selected=0<this.controlPoints.length?this.controlPoints[0<a?a-1:0]:null;this._redraw()}},_export:function(){var a=JSON.stringify(this.controlPoints),b=document.createElement("a");
    document.body.appendChild(b);b.style="display: none";a=new Blob([a],{type:"octet/stream"});a=window.URL.createObjectURL(a);b.href=a;b.download="transferFunction.json";b.click();window.URL.revokeObjectURL(a)},getCanvas:function(){return this.$$(this.canvasSelector)},getCanvasSelector:function(){return this.canvasSelector},setCanvas:function(a){},setData:function(a){this._data=a;this._updateScales();this._updateAxis();this._redraw();this._redrawHistogram()},created:function(){this._createElements()},
    ready:function(){this.scopeSubtree(this.$.container,!0);this.svg=d3.select(this.$$("svg"));this._width=+this.svg.attr("width")-this.margin.left-this.margin.right;this._height=+this.svg.attr("height")-this.margin.top-this.margin.bottom-15;this._initializeElements();this._drawChart()},attached:function(){""!=this.x3domSelector&&this._x3domSelectorChanged(this.x3domSelector,"")},_isCanvasNeeded:function(a){return""===a||a==="#canvas-"+this.id},properties:{id:{type:String,value:"tf-1"},name:{type:String,
    value:"TF-Editor"},x3domSelector:{type:String,value:"",observer:"_x3domSelectorChanged"},canvasSelector:{type:String,value:"",observer:"_canvasSelectorChanged"},_external:{type:Boolean,computed:"_isCanvasNeeded(canvasSelector)"},width:{type:Number,value:375},height:{type:Number,value:200},numberBins:{type:Number,value:100},numberTicks:{type:Number,value:4},fitToData:{type:Boolean,value:!0},controlPoints:{type:Array,value:function(){return[]},reflectToAttribute:!0,notify:!0}},_x3domSelectorChanged:function(a,
    b){if(void 0!=a&&""!=a&&a!=b){var c=this,e=new Image;e.onload=function(){var a=[],b=document.createElement("canvas").getContext("2d");b.drawImage(this,0,0);for(var b=b.getImageData(0,0,this.width,this.height),d=0,e=b.data.length;d<e;d+=4)a.push(b.data[d]);c.setData(a)};var d=document.querySelector(a);if(void 0!=d&&d.hasOwnProperty("_x3domNode")){var g="";if("opacitymapvolumestyle"===d.localName||"blendedvolumestyle"===d.localName){var f=null,f="composedvolumestyle"==d.parentNode.localName?d.parentNode.parentNode.querySelector("imagetexture[containerField='transferFunction' i]"):
    d.parentNode.querySelector("imagetexture[containerField='transferFunction' i]");null!=f&&(g=f.getAttribute("url"))}else if("volumedata"===d.localName||"segmentedvolumedata"===d.localName||"isosurfacevolumedata"===d.localName)g=d.querySelector("imagetextureatlas[containerField='voxels' i]").getAttribute("url");else if("imagetextureatlas"===d.localName&&"voxels"===d.getAttribute("containerField").toLowerCase())g=d.getAttribute("url");else return;f=d.querySelector("imagetexture[containerField='transferFunction' i]");
    if(null!=f&&""!=f.getAttribute("url"))console.log("WARN: An image texture with a loaded TF founded.");else if(null!=f&&"transferfunction"===f.getAttribute("containerField").toLowerCase()){if(0<f.children.length)f.children[0].setAttribute("id","tf-canvas-"+this.id);else{f.setAttribute("hideChildren","true");var h=document.createElement("canvas");h.setAttribute("id","tf-canvas-"+this.id);h.setAttribute("width","255px");h.setAttribute("height","1px");f.append(h);setTimeout(function(){x3dom.reload()},
    1E3)}this.canvasSelector="#tf-canvas-"+this.id}if(""==g){if(e=null,"imagetextureatlas"===d.localName?0<d.children.length&&(e=d.children[0]):(d=d.querySelector("imagetextureatlas[containerField='voxels' i]"),null!=d&&0<d.children.length&&(e=d.children[0])),null!=e){for(var d=[],e=e.getContext("2d").getImageData(0,0,e.width,e.height),f=-Number.MAX_VALUE,h=0,k=e.data.length;h<k;h+=4)g=e.data[h],f=Math.max(g,f),d.push(g);if(0==f)return;this.setData(d)}}else e.src=g}this._drawCanvas()}},_canvasSelectorChanged:function(a,
    b){if(""!=a){var c=document.querySelector(a);null!=c&&"canvas"===c.localName?(c.setAttribute("id","tf-canvas-"+this.id),c.setAttribute("width","255px"),c.setAttribute("height","5px")):null!=c&&"canvas"!=c.localName&&(this.canvasSelector=b);this._drawCanvas()}}});
    </script>
</dom-module>
</body></html>
