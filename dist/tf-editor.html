<!--
@license
Copyright (c) 2016 Vicomtech-IK4. All rights reserved.
This code may only be used under the Apache License 2.0 found at http://volumerc.github.io/tf-editor/LICENSE.txt
The complete set of attributions may be found at http://volumerc.github.io/tf-editor/NOTICE
-->
<html><head><meta charset="UTF-8">
<!--
`<tf-editor>`
A Web based transfer function editor for volume rendering.

Typical use, just insert `<tf-editor>` along a volume rendering scene into your
page. Optionally, pass the volume data as a flatten array to show an histogram
and fit the control points to the data.

    <body>
      <tf-editor id="TF"></tf-editor>
    </body>

The output canvas selector string will be reflected in the `output` attribute,
if no input selector is provided.
Check out the demo page for examples of the different use cases in action.

@demo ./demo/index.html  Showcase of the different attribute arguments!
-->
</head><body>
  <div hidden="" by-vulcanize="">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.8.0/d3.min.js"></script>
  </div>
  <dom-module id="tf-editor">
    <template>
    <style>
      :host{display:block}.bar rect{fill:steelblue}.aligned{margin:0 auto;display:inline-flex}button{border:1px solid;padding:1px 2px;margin-right:2px;margin-left:2px;height:23px;cursor:pointer;overflow:visible}button::-moz-focus-inner{border:0;padding:1px 2px}input[type=color]{border:1px solid;width:44px;height:23px;margin-left:2px;margin-right:2px;padding:1px 2px;cursor:pointer}rect{fill:none;pointer-events:all}.line{stroke:black;stroke-width:1.5px}circle{fill-opacity:.6;cursor:move;stroke:black;stroke-width:1.5px}.selected{fill:#ff7f0e;stroke:#ff7f0e}
    </style>
    <div id="container">
      <svg id="svg-{{id}}" width$="{{width}}" height$="{{height}}"></svg>
      <div class="aligned">
        <input type="color" id="picker-{{id}}">
        <button id="export-{{id}}">Export</button>
        <template is="dom-if" if="{{_external}}">
          <canvas id="canvas-{{id}}" width="255" height="10"></canvas>
        </template>
    </div>
    </div>
    </template>
    <script>
Polymer({is:"tf-editor",_createElements:function(){this.margin={top:10,right:20,bottom:20,left:25},this.formatCount=d3.format(",.0f"),this.xScale=d3.scaleLinear(),this.yScale=d3.scaleLinear(),this.binScale=d3.scaleLog(),this.area=d3.area(),this.bins=d3.histogram(),this.canvasScale=d3.scaleLinear(),this.dataScale=d3.scaleLinear(),this.dragged=null,this.selected=null,this.last_color="green"},_initializeElements:function(){var t=[0,255];this.fitToData&&this._data&&this._data.length>0&&(t=d3.extent(this._data));var e=this;this.xScale.rangeRound([0,this._width]).domain(t),this.yScale.domain([0,1]).range([this._height,0]),this.binScale.domain([1,10]).range([this._height,0]).base(2).clamp([0,this._height]),this.bins.domain(this.xScale.domain()).thresholds(this.xScale.ticks(this.numberBins)),0==this.controlPoints.length&&(this.push("controlPoints",{x:t[0],opacity:0,color:"blue"}),this.push("controlPoints",{x:t[1],opacity:1,color:"red"})),this.selected=this.controlPoints[0],this.area.x(function(t){return e.xScale(t.x)}).y0(function(t){return e.yScale(t.opacity)}).y1(this._height).curve(d3.curveLinear),this.canvasScale.range([0,1]),this.dataScale.domain(t).range([0,255]),this.canvasSelector=this.canvasSelector||"#canvas-"+this.id,this.$$("#picker-"+this.id).addEventListener("change",function(){e.last_color=this.value}),this.$$("#export-"+this.id).addEventListener("click",function(){e._export.call(e)})},_canvasContext:function(){var t=this._external?this.$$(this.canvasSelector):document.querySelector(this.canvasSelector);return null!=t?t.getContext("2d"):t},_drawChart:function(){var t=this,e=this.svg.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")");this._redrawHistogram(),e.append("defs").append("linearGradient").attr("id","tfGradient-"+this.id).attr("gradientUnits","objectBoundingBox").attr("spreadMethod","pad").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%"),e.append("path").datum(t.controlPoints).attr("class","line").attr("fill","url(#tfGradient-"+this.id+")").attr("stroke","black").call(function(){t._redraw()}),e.append("rect").attr("y",-10).attr("x",-10).attr("width",t._width+20).attr("height",t._height+20).style("opacity",0).on("mousedown",function(){t._mousedown()}).on("mouseup",function(){t._mouseup()}).on("mousemove",function(){t._mousemove()});var i=t.xScale.ticks(t.numberTicks);i[i.length-1]=t.xScale.domain()[1],e.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+t._height+")").call(d3.axisBottom(t.xScale).tickValues(i)),e.append("g").attr("class","axis axis--y").attr("transform","translate(0, 0)").call(d3.axisLeft(t.yScale).ticks(t.numberTicks))},_updateScales:function(){if(this.fitToData){for(var t=d3.extent(this._data),e=-1,i=-1,a=this.controlPoints,n=a.length-1;n>=0;n--)if(i=a[n].x>=t[1]?n:i,a[n].x<=t[0]){e=n;break}-1!=i&&(a[i].x=t[1],a.splice(i,a.length-i-1)),-1!=e&&(a[e].x=t[0],a.splice(0,e)),this.controlPoints=[],this.controlPoints=a,this.xScale.domain(t),this.dataScale.domain(t)}else this.xScale.domain([0,255]),this.dataScale.domain([0,255]);this.bins.domain(this.xScale.domain()).thresholds(this.xScale.ticks(this.numberBins))},_updateAxis:function(){var t=d3.select(this.$$("svg")).select("g"),e=this.xScale.ticks(this.numberTicks);e[e.length-1]=this.xScale.domain()[1],t.selectAll(".axis.axis--x").call(d3.axisBottom(this.xScale).tickValues(e))},_redrawHistogram:function(){var t=this;if(this.svg.select("g").selectAll(".bar").remove(),this._data&&this._data.length>0){var e=this.bins(this._data);this.binScale.domain([.1,d3.max(e,function(t){return t.length})]);var i=this.svg.select("g").selectAll(".bar").data(e);i.enter().append("g").attr("class","bar").attr("transform",function(e){return"translate("+t.xScale(e.x0)+","+t.binScale(e.length)+")"}).append("rect").attr("x",1).attr("width",function(t){return t.x1-t.x0}).attr("height",function(e){return t._height-t.binScale(e.length)}),this.svg.select("g").selectAll(".bar").lower(),i.exit().remove()}},_redraw:function(){var t=this,e=d3.select(t.$$("svg")).select("g");e.select("path").datum(t.controlPoints).attr("d",t.area);var i=e.selectAll("circle").data(t.controlPoints);i.enter().append("circle").attr("cx",function(e){return t.xScale(e.x)}).attr("cy",function(e){return t.yScale(e.opacity)}).style("fill",function(t){return t.color}).attr("r",1e-6).on("mousedown",function(e){t.selected=t.dragged=e,t.last_color=e.color,t._redraw()}).on("mouseup",function(){t._mouseup()}).on("contextmenu",function(e,i){d3.event.preventDefault(),e.color=t.$$("#picker-"+t.id).value,t._redraw()}).transition().duration(750).attr("r",5),i.classed("selected",function(e){return e===t.selected}).style("fill",function(t){return t.color}).attr("cx",function(e){return t.xScale(e.x)}).attr("cy",function(e){return t.yScale(e.opacity)}).raise(),i.exit().remove();var a=e.select("linearGradient").selectAll("stop").data(t.controlPoints);a.enter().append("stop").attr("stop-color",function(t){return t.color}).attr("stop-opacity",function(t){return t.opacity}).attr("offset",function(e){var i=t.controlPoints[t.controlPoints.length-1].x-t.controlPoints[0].x;return(e.x-t.controlPoints[0].x)/i*100+"%"}),a.attr("stop-color",function(t){return t.color}).attr("stop-opacity",function(t){return t.opacity}).attr("offset",function(e){var i=t.controlPoints[t.controlPoints.length-1].x-t.controlPoints[0].x;return(e.x-t.controlPoints[0].x)/i*100+"%"}),a.exit().remove(),d3.event&&(d3.event.preventDefault(),d3.event.stopPropagation());var n=this.controlPoints;this.controlPoints=[],this.controlPoints=n,d3.timeout(function(){t._drawCanvas()},100)},_drawCanvas:function(){if(void 0!=this.controlPoints&&this.controlPoints.length>0){var t=[this.controlPoints[0].x,this.controlPoints[this.controlPoints.length-1].x],e=this.dataScale(t[0]),i=this.dataScale(t[1]);this.canvasScale.domain([e,i]);var a=this._canvasContext();if(null==a)return;a.clearRect(0,0,255,10);for(var n=a.createLinearGradient(e,0,i,0),o=0;o<this.controlPoints.length;o++){var r=this.controlPoints[o],s=d3.color(r.color);s.opacity=r.opacity,n.addColorStop(this.canvasScale(this.dataScale(r.x)),s.toString())}a.fillStyle=n,a.fillRect(e,0,i-e,10),void 0!=a.canvas.parentNode._x3domNode&&a.canvas.parentNode._x3domNode.invalidateGLObject()}},_mousedown:function(){var t=this,e=d3.mouse(t.svg.node());point={x:t.xScale.invert(Math.max(0,Math.min(e[0]-t.margin.left,t._width))),opacity:t.yScale.invert(Math.max(0,Math.min(e[1]-t.margin.top,t._height))),color:t.last_color},t.selected=t.dragged=point;var i=d3.bisector(function(t,e){return t.x-e.x}).left,a=i(t.controlPoints,point);t.splice("controlPoints",a,0,point),t._redraw()},_mousemove:function(){function t(t,e,i){return t.x==this.x&&t.opacity==this.opacity&&t.color==this.color}if(this.dragged){var e=this.controlPoints.findIndex(t,this.selected);if(-1!=e){var i=d3.mouse(this.svg.node());this.selected=this.dragged=this.controlPoints[e],this.dragged.x=this.xScale.invert(Math.max(0,Math.min(this._width,i[0]-this.margin.left))),this.dragged.opacity=this.yScale.invert(Math.max(0,Math.min(this._height,i[1]-this.margin.top)));var a=d3.bisector(function(t,e){return t.x-e.x}).left,n=d3.bisector(function(t,e){return t.x-e.x}).right,o=a(this.controlPoints,this.dragged),r=n(this.controlPoints,this.dragged);o<e?this.splice("controlPoints",o,1):o>e?this.splice("controlPoints",e+1,1):r-e>=2&&this.splice("controlPoints",e+1,1),this._redraw()}}},_mouseup:function(){this.dragged&&(this.dragged=null)},_keydown:function(){if(this.selected)switch(d3.event.keyCode){case 46:var t=this.controlPoints.indexOf(this.selected);this.splice("controlPoints",t,1),this.selected=this.controlPoints.length>0?this.controlPoints[t>0?t-1:0]:null,this._redraw()}},_export:function(){var t=JSON.stringify(this.controlPoints),e=document.createElement("a");document.body.appendChild(e),e.style="display: none";var i=new Blob([t],{type:"octet/stream"}),a=window.URL.createObjectURL(i);e.href=a,e.download="transferFunction.json",e.click(),window.URL.revokeObjectURL(a)},getCanvas:function(){return this.$$(this.canvasSelector)},getCanvasSelector:function(){return this.canvasSelector},setCanvas:function(t){},setData:function(t){this._data=t,this._updateScales(),this._updateAxis(),this._redraw(),this._redrawHistogram()},created:function(){this._createElements()},ready:function(){this.scopeSubtree(this.$.container,!0),this.svg=d3.select(this.$$("svg")),this._width=+this.svg.attr("width")-this.margin.left-this.margin.right,this._height=+this.svg.attr("height")-this.margin.top-this.margin.bottom-15,this._initializeElements(),this._drawChart()},attached:function(){""!=this.x3domSelector&&this._x3domSelectorChanged(this.x3domSelector,"")},_isCanvasNeeded:function(t){return""===t||t==="#canvas-"+this.id},properties:{id:{type:String,value:"tf-1"},name:{type:String,value:"TF-Editor"},x3domSelector:{type:String,value:"",observer:"_x3domSelectorChanged"},canvasSelector:{type:String,value:"",observer:"_canvasSelectorChanged"},_external:{type:Boolean,computed:"_isCanvasNeeded(canvasSelector)"},width:{type:Number,value:375},height:{type:Number,value:200},numberBins:{type:Number,value:100},numberTicks:{type:Number,value:4},fitToData:{type:Boolean,value:!0},controlPoints:{type:Array,value:function(){return[]},reflectToAttribute:!0,notify:!0}},_x3domSelectorChanged:function(t,e){if(void 0!=t&&""!=t&&t!=e){var i=this,a=new Image;a.onload=function(){var t=[],e=document.createElement("canvas"),a=e.getContext("2d");a.drawImage(this,0,0);for(var n=a.getImageData(0,0,this.width,this.height),o=0,r=n.data.length;o<r;o+=4)t.push(n.data[o]);i.setData(t)};var n=document.querySelector(t);if(void 0!=n&&n.hasOwnProperty("_x3domNode")){var o="";if("opacitymapvolumestyle"===n.localName||"blendedvolumestyle"===n.localName){var r=null;r="composedvolumestyle"==n.parentNode.localName?n.parentNode.parentNode.querySelector("imagetexture[containerField='transferFunction' i]"):n.parentNode.querySelector("imagetexture[containerField='transferFunction' i]"),null!=r&&(o=r.getAttribute("url"))}else if("volumedata"===n.localName||"segmentedvolumedata"===n.localName||"isosurfacevolumedata"===n.localName)o=n.querySelector("imagetextureatlas[containerField='voxels' i]").getAttribute("url");else{if("imagetextureatlas"!==n.localName||"voxels"!==n.getAttribute("containerField").toLowerCase())return;o=n.getAttribute("url")}var s=n.querySelector("imagetexture[containerField='transferFunction' i]");if(null!=s&&""!=s.getAttribute("url"))console.log("WARN: An image texture with a loaded TF founded.");else if(null!=s&&"transferfunction"===s.getAttribute("containerField").toLowerCase()){if(s.children.length>0)s.children[0].setAttribute("id","tf-canvas-"+this.id);else{s.setAttribute("hideChildren","true");var l=document.createElement("canvas");l.setAttribute("id","tf-canvas-"+this.id),l.setAttribute("width","255px"),l.setAttribute("height","1px"),s.append(l),setTimeout(function(){x3dom.reload()},1e3)}this.canvasSelector="#tf-canvas-"+this.id}if(""==o){var c=null;if("imagetextureatlas"===n.localName)n.children.length>0&&(c=n.children[0]);else{var h=n.querySelector("imagetextureatlas[containerField='voxels' i]");null!=h&&h.children.length>0&&(c=h.children[0])}if(null!=c){for(var d,u=[],g=c.getContext("2d"),m=g.getImageData(0,0,c.width,c.height),v=-Number.MAX_VALUE,f=0,p=m.data.length;f<p;f+=4)d=m.data[f],v=Math.max(d,v),u.push(d);if(0==v)return;this.setData(u)}}else a.src=o}this._drawCanvas()}},_canvasSelectorChanged:function(t,e){if(""!=t){var i=document.querySelector(t);null!=i&&"canvas"===i.localName?(i.setAttribute("id","tf-canvas-"+this.id),i.setAttribute("width","255px"),i.setAttribute("height","5px")):null!=i&&"canvas"!=i.localName&&(this.canvasSelector=e),this._drawCanvas()}}});
    </script>
</dom-module>
</body></html>
