<html><head><meta charset="UTF-8">
</head><body><div hidden="" by-vulcanize=""><!--
@license
Copyright (c) 2016 Vicomtech-IK4. All rights reserved.
This code may only be used under the Apache License 2.0 found at http://volumerc.github.io/tf-editor/LICENSE.txt
The complete set of attributions may be found at http://volumerc.github.io/tf-editor/NOTICE
--><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.8.0/d3.min.js"></script>

<!--
`<tf-editor>`
A Web based transfer function editor for volume rendering.

Typical use, just insert `<tf-editor>` along a volume rendering scene into your
page. Optionally, pass the volume data as a flatten array to show an histogram
and fit the control points to the data.

    <body>
      <tf-editor id="TF"></tf-editor>
    </body>

The output canvas selector string will be reflected in the `output` attribute,
if no input selector is provided.
Check out the demo page for examples of the different use cases in action.

@demo ./demo/index.html  Showcase of the different attribute arguments!
-->
<dom-module id="tf-editor" assetpath="./">
    <template>
    <style>
    :host{display:block}.bar rect{fill:steelblue}.aligned{margin:0 auto;display:inline-flex}button{border:1px solid;padding:1px 2px;margin-right:2px;margin-left:2px;height:23px;cursor:pointer;overflow:visible}button::-moz-focus-inner{border:0;padding:1px 2px}input[type=color]{border:1px solid;width:44px;height:23px;margin-left:2px;margin-right:2px;padding:1px 2px;cursor:pointer}rect{fill:none;pointer-events:all}.line{stroke:black;stroke-width:1.5px}circle{fill-opacity:.6;cursor:move;stroke:black;stroke-width:1.5px}.selected{fill:#ff7f0e;stroke:#ff7f0e}
    </style>
    <div id="container">
      <svg id="svg-{{id}}" width$="{{width}}" height$="{{height}}"></svg>
      <div class="aligned">
        <input type="color" id="picker-{{id}}">
        <button id="export-{{id}}">Export</button>
        <template is="dom-if" if="{{_external}}">
          <canvas id="canvas-{{id}}" width="255" height="10"></canvas>
        </template>
    </div>
    </div>
    </template>
    <script>
Polymer({is:"tf-editor",_createElements:function(){this.margin={top:10,right:20,bottom:20,left:25};this.formatCount=d3.format(",.0f");this.xScale=d3.scaleLinear();this.yScale=d3.scaleLinear();this.binScale=d3.scaleLog();this.area=d3.area();this.bins=d3.histogram();this.canvasScale=d3.scaleLinear();this.dataScale=d3.scaleLinear();this.dragged=null;this.selected=null;this.last_color="green"},_initializeElements:function(){var a=[0,255];if(this.fitToData&&this._data&&this._data.length>0){a=d3.extent(this._data)}var b=this;this.xScale.rangeRound([0,this._width]).domain(a);this.yScale.domain([0,1]).range([this._height,0]);this.binScale.domain([1,10]).range([this._height,0]).base(2).clamp([0,this._height]);this.bins.domain(this.xScale.domain()).thresholds(this.xScale.ticks(this.numberBins));if(this.controlPoints.length==0){this.push("controlPoints",{x:a[0],opacity:0,color:"blue"});this.push("controlPoints",{x:a[1],opacity:1,color:"red"})}this.selected=this.controlPoints[0];this.area.x(function(c){return b.xScale(c.x)}).y0(function(c){return b.yScale(c.opacity)}).y1(this._height).curve(d3.curveLinear);this.canvasScale.range([0,1]);this.dataScale.domain(a).range([0,255]);this.canvasSelector=this.canvasSelector||"#canvas-"+this.id;this.canvasContext=function(){if(b._external==true){return b.$$(b.canvasSelector).getContext("2d")}else{return document.querySelector(b.canvasSelector).getContext("2d")}};this.$$("#picker-"+this.id).addEventListener("change",function(){b.last_color=this.value});this.$$("#export-"+this.id).addEventListener("click",function(){b._export.call(b)})},_drawChart:function(){var b=this;var a=this.svg.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")");this._redrawHistogram();a.append("defs").append("linearGradient").attr("id","tfGradient-"+this.id).attr("gradientUnits","objectBoundingBox").attr("spreadMethod","pad").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%");a.append("path").datum(b.controlPoints).attr("class","line").attr("fill","url(#tfGradient-"+this.id+")").attr("stroke","black").call(function(){b._redraw()});a.append("rect").attr("width",b._width).attr("height",b._height).style("opacity",0).on("mousedown",function(){b._mousedown()}).on("mouseup",function(){b._mouseup()}).on("mousemove",function(){b._mousemove()});a.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+b._height+")").call(d3.axisBottom(b.xScale).ticks(this.numberTicks));a.append("g").attr("class","axis axis--y").attr("transform","translate(0, 0)").call(d3.axisLeft(b.yScale).ticks(this.numberTicks))},_updateScales:function(){if(this.fitToData){var e=d3.extent(this._data);var d=-1;var b=-1;var a=this.controlPoints;for(var c=a.length-1;c>=0;c--){b=(a[c].x>=e[1])?c:b;if(a[c].x<=e[0]){d=c;break}}if(b!=-1){a[b].x=e[1];a.splice(b,a.length-b-1)}if(d!=-1){a[d].x=e[0];a.splice(0,d)}this.controlPoints=[];this.controlPoints=a;this.xScale.domain(e);this.dataScale.domain(e)}else{this.xScale.domain([0,255]);this.dataScale.domain([0,255])}},_updateAxis:function(){var a=d3.select(this.$$("svg")).select("g");a.selectAll(".axis.axis--x").call(d3.axisBottom(this.xScale).ticks(this.numberTicks))},_redrawHistogram:function(){var c=this;this.svg.select("g").selectAll(".bar").remove();if(this._data&&this._data.length>0){var b=this.bins(this._data);this.binScale.domain([0.1,d3.max(b,function(e){return e.length})]);var a=this.svg.select("g").selectAll(".bar").data(b);var d=a.enter().append("g").attr("class","bar").attr("transform",function(e){return"translate("+c.xScale(e.x0)+","+c.binScale(e.length)+")"});d.append("rect").attr("x",1).attr("width",this.xScale(b[0].x1)-this.xScale(b[0].x0)-1).attr("height",function(e){return c._height-c.binScale(e.length)});this.svg.select("g").selectAll(".bar").lower();a.exit().remove()}},_redraw:function(){var c=this;var b=d3.select(c.$$("svg")).select("g");b.select("path").datum(c.controlPoints).attr("d",c.area);var e=b.selectAll("circle").data(c.controlPoints);e.enter().append("circle").attr("cx",function(f){return c.xScale(f.x)}).attr("cy",function(f){return c.yScale(f.opacity)}).style("fill",function(f){return f.color}).attr("r",0.000001).on("mousedown",function(f){c.selected=c.dragged=f;c.last_color=f.color;c._redraw()}).on("mouseup",function(){c._mouseup()}).on("contextmenu",function(g,f){d3.event.preventDefault();g.color=c.$$("#picker-"+c.id).value;c._redraw()}).transition().duration(750).attr("r",5);e.classed("selected",function(f){return f===c.selected}).style("fill",function(f){return f.color}).attr("cx",function(f){return c.xScale(f.x)}).attr("cy",function(f){return c.yScale(f.opacity)}).raise();e.exit().remove();var d=b.select("linearGradient").selectAll("stop").data(c.controlPoints);d.enter().append("stop").attr("stop-color",function(f){return f.color}).attr("stop-opacity",function(f){return f.opacity}).attr("offset",function(g){var f=(c.controlPoints[c.controlPoints.length-1].x-c.controlPoints[0].x);return""+((g.x-c.controlPoints[0].x)/f*100)+"%"});d.attr("stop-color",function(f){return f.color}).attr("stop-opacity",function(f){return f.opacity}).attr("offset",function(g){var f=(c.controlPoints[c.controlPoints.length-1].x-c.controlPoints[0].x);return""+((g.x-c.controlPoints[0].x)/f*100)+"%"});d.exit().remove();if(d3.event){d3.event.preventDefault();d3.event.stopPropagation()}var a=this.controlPoints;this.controlPoints=[];this.controlPoints=a;setTimeout(function(){c._drawCanvas()},100)},_drawCanvas:function(){if(this.controlPoints!=undefined&&this.controlPoints.length>0){var h=[this.controlPoints[0].x,this.controlPoints[this.controlPoints.length-1].x];var g=this.dataScale(h[0]),e=this.dataScale(h[1]);this.canvasScale.domain([g,e]);var b=this.canvasContext();b.clearRect(0,0,255,10);var a=b.createLinearGradient(g,0,e,0);for(var f=0;f<this.controlPoints.length;f++){var j=this.controlPoints[f];var c=d3.color(j.color);c.opacity=j.opacity;a.addColorStop(this.canvasScale(this.dataScale(j.x)),c.toString())}b.fillStyle=a;b.fillRect(g,0,e-g,10);if(b.canvas.parentNode._x3domNode!=undefined){b.canvas.parentNode._x3domNode.invalidateGLObject()}}},_mousedown:function(){var a=this;var d=d3.mouse(a.svg.node());point={x:a.xScale.invert(d[0]-a.margin.left),opacity:a.yScale.invert(d[1]-a.margin.top),color:a.last_color};a.selected=a.dragged=point;var c=d3.bisector(function(f,e){return f.x-e.x}).left;var b=c(a.controlPoints,point);a.splice("controlPoints",b,0,point);a._redraw()},_mousemove:function(){if(!this.dragged){return}function e(h,i,j){return h.x==this.x&&h.opacity==this.opacity&&h.color==this.color}var c=this.controlPoints.findIndex(e,this.selected);if(c==-1){return}var a=d3.mouse(this.svg.node());this.selected=this.dragged=this.controlPoints[c];this.dragged.x=this.xScale.invert(Math.max(0,Math.min(this._width,a[0]-this.margin.left)));this.dragged.opacity=this.yScale.invert(Math.max(0,Math.min(this._height,a[1]-this.margin.top)));var g=d3.bisector(function(i,h){return i.x-h.x}).left;var d=d3.bisector(function(i,h){return i.x-h.x}).right;var b=g(this.controlPoints,this.dragged);var f=d(this.controlPoints,this.dragged);if(b<c){this.splice("controlPoints",b,1)}else{if(b>c){this.splice("controlPoints",c+1,1)}else{if(f-c>=2){this.splice("controlPoints",c+1,1)}}}this._redraw()},_mouseup:function(){if(!this.dragged){return}this.dragged=null},_keydown:function(){if(!this.selected){return}switch(d3.event.keyCode){case 46:var a=this.controlPoints.indexOf(this.selected);this.splice("controlPoints",a,1);this.selected=this.controlPoints.length>0?this.controlPoints[a>0?a-1:0]:null;this._redraw();break}},_export:function(){var d=JSON.stringify(this.controlPoints);var b=document.createElement("a");document.body.appendChild(b);b.style="display: none";var c=new Blob([d],{type:"octet/stream"});var e=window.URL.createObjectURL(c);b.href=e;b.download="transferFunction.json";b.click();window.URL.revokeObjectURL(e)},getCanvas:function(){return this.$$(this.canvasSelector)},getCanvasSelector:function(){return this.canvasSelector},setCanvas:function(a){return this.canvasContext=a.getContext("2d")},setData:function(a){this._data=a;this._updateScales();this._updateAxis();this._redraw();this._redrawHistogram()},created:function(){this._createElements()},ready:function(){this.scopeSubtree(this.$.container,true);this.svg=d3.select(this.$$("svg"));this._width=+this.svg.attr("width")-this.margin.left-this.margin.right;this._height=+this.svg.attr("height")-this.margin.top-this.margin.bottom-15;this._initializeElements();this._drawChart()},attached:function(){if(this.x3domSelector!=""){this._x3domSelectorChanged(this.x3domSelector,"")}},_isCanvasNeeded:function(a){return a===""||a==="#canvas-"+this.id},properties:{id:{type:String,value:"tf-1",},name:{type:String,value:"TF-Editor",},x3domSelector:{type:String,value:"",observer:"_x3domSelectorChanged",},canvasSelector:{type:String,value:"",observer:"_canvasSelectorChanged",},_external:{type:Boolean,computed:"_isCanvasNeeded(canvasSelector)",},width:{type:Number,value:375,},height:{type:Number,value:200,},numberBins:{type:Number,value:100,},numberTicks:{type:Number,value:4,},fitToData:{type:Boolean,value:true,},controlPoints:{type:Array,value:function(){return[]},reflectToAttribute:true,notify:true}},_x3domSelectorChanged:function(c,a){if(c!=undefined&&c!=""&&c!=a){var i=this;var e=new Image();e.onload=function(){var j=[];var k=document.createElement("canvas");var m=k.getContext("2d");m.drawImage(this,0,0);var o=m.getImageData(0,0,this.width,this.height);for(var l=0,p=o.data.length;l<p;l+=4){j.push(o.data[l])}i.setData(j)};var g=document.querySelector(c);if(g!=undefined&&g.hasOwnProperty("_x3domNode")){var h="";if(g.localName==="opacitymapvolumestyle"||g.localName==="blendedvolumestyle"){var b=null;if(g.parentNode.localName=="composedvolumestyle"){b=g.parentNode.parentNode.querySelector("imagetexture[containerField='transferFunction' i]")}else{b=g.parentNode.querySelector("imagetexture[containerField='transferFunction' i]")}if(b!=null){h=b.getAttribute("url")}}else{if(g.localName==="volumedata"||g.localName==="segmentedvolumedata"||g.localName==="isosurfacevolumedata"){h=g.querySelector("imagetextureatlas[containerField='voxels' i]").getAttribute("url")}else{if(g.localName==="imagetextureatlas"&&g.getAttribute("containerField").toLowerCase()==="voxels"){h=g.getAttribute("url")}else{return}}}var f=g.querySelector("imagetexture[containerField='transferFunction' i]");if(f!=null&&f.getAttribute("url")!=""){console.log("WARN: An image texture with a loaded TF founded.")}else{if(f!=null&&f.getAttribute("containerField").toLowerCase()==="transferfunction"){if(f.children.length>0){f.children[0].setAttribute("id","tf-canvas-"+this.id)}else{f.setAttribute("hideChildren","true");var d=document.createElement("canvas");d.setAttribute("id","tf-canvas-"+this.id);d.setAttribute("width","255px");d.setAttribute("height","1px");f.append(d);setTimeout(function(){x3dom.reload()},1000)}this.canvasSelector="#tf-canvas-"+this.id}}e.src=h}}},_canvasSelectorChanged:function(b,a){if(b!=""){var c=document.querySelector(b);if(c!=null&&c.localName==="canvas"){c.setAttribute("id","tf-canvas-"+this.id);c.setAttribute("width","255px");c.setAttribute("height","5px")}else{if(c!=null&&c.localName!="canvas"){this.canvasSelector=a}}}}});
    </script>
</dom-module>
</div></body></html>
